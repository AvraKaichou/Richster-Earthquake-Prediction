# -*- coding: utf-8 -*-
"""main_app (1).ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/16JRydKfFpaKsIoZxYMdAKRs_npAj_ocC
"""

import streamlit as st
import joblib
import numpy as np
import pandas as pd

# Load model dan preprocessing
model = joblib.load('catboost_model.pkl')
scaler = joblib.load('scaler.pkl')
pca = joblib.load('pca.pkl')
feature_names = joblib.load('feature_names.pkl')  # 15 fitur total
pca_input_features = [col for col in feature_names if col not in ['count_floors_pre_eq', 'count_families']]  # 13 fitur ke PCA

st.set_page_config(page_title="Prediksi Kerusakan Bangunan", layout="centered")
st.title("üèöÔ∏è Prediksi Tingkat Kerusakan Bangunan akibat Gempa")

# ==== Input dari user ====
inputs = {}
inputs['geo_level_1_id'] = st.number_input("Geo Level 1 ID", 0, 50, 15)
inputs['geo_level_2_id'] = st.number_input("Geo Level 2 ID", 0, 100, 25)
inputs['geo_level_3_id'] = st.number_input("Geo Level 3 ID", 0, 200, 50)
inputs['count_floors_pre_eq'] = st.number_input("Jumlah Lantai Sebelum Gempa", 1, 10, 2)
inputs['age'] = st.number_input("Umur Bangunan (tahun)", 0, 150, 20)
inputs['area_percentage'] = st.slider("Persentase Area (%)", 0, 100, 10)
inputs['height_percentage'] = st.slider("Persentase Tinggi (%)", 0, 100, 5)

# Kategorikal
inputs['land_surface_condition'] = st.selectbox("Kondisi Permukaan Tanah", ["Flat", "Moderate", "Steep"])
inputs['foundation_type'] = st.selectbox("Tipe Pondasi", ["RC", "Stone", "Mud", "Brick", "Other"])
inputs['roof_type'] = st.selectbox("Tipe Atap", ["Bamboo", "Metal", "Thatched", "Other"])
inputs['ground_floor_type'] = st.selectbox("Tipe Lantai Dasar", ["Mud", "Cement", "Wood", "Brick"])
inputs['other_floor_type'] = st.selectbox("Tipe Lantai Atas", ["None", "Timber", "RC", "Other"])
inputs['position'] = st.selectbox("Posisi Bangunan", ["Attached", "Corner", "Independent"])
inputs['plan_configuration'] = st.selectbox("Konfigurasi Rencana", ["Rectangular", "Square", "L-shape", "T-shape", "Other"])
inputs['has_superstructure_timber'] = st.selectbox("Struktur Superstruktur Kayu", ["Tidak", "Ya"])
inputs['legal_ownership_status'] = st.selectbox("Status Kepemilikan Legal", ["Milik Pribadi", "Sewa", "Lainnya"])
inputs['count_families'] = st.number_input("Jumlah Keluarga", 1, 20, 1)

# Mapping kategori ke angka
mappings = {
    'land_surface_condition': {"Flat": 0, "Moderate": 1, "Steep": 2},
    'foundation_type': {"RC": 0, "Stone": 1, "Mud": 2, "Brick": 3, "Other": 4},
    'roof_type': {"Bamboo": 0, "Metal": 1, "Thatched": 2, "Other": 3},
    'ground_floor_type': {"Mud": 0, "Cement": 1, "Wood": 2, "Brick": 3},
    'other_floor_type': {"None": 0, "Timber": 1, "RC": 2, "Other": 3},
    'position': {"Attached": 0, "Corner": 1, "Independent": 2},
    'plan_configuration': {"Rectangular": 0, "Square": 1, "L-shape": 2, "T-shape": 3, "Other": 4},
    'has_superstructure_timber': {"Tidak": 0, "Ya": 1},
    'legal_ownership_status': {"Milik Pribadi": 0, "Sewa": 1, "Lainnya": 2}
}

# Apply mapping
for key, mapping in mappings.items():
    inputs[key] = mapping[inputs[key]]

# Buat DataFrame final sesuai feature_names
df = pd.DataFrame([[inputs[col] for col in feature_names]], columns=feature_names)

# ==== Prediksi ====
if st.button("üîç Prediksi"):
    try:
        # Scaling
        df_scaled = scaler.transform(df)

        # Ambil fitur untuk PCA (13 fitur saja)
        df_scaled_pca = pd.DataFrame(df_scaled, columns=feature_names)[pca_input_features]

        # Transform PCA
        data_pca = pca.transform(df_scaled_pca)

        # Prediksi
        pred = model.predict(data_pca)[0]
        label = ["Low", "Medium", "High"][int(pred)]

        st.success(f"üè∑Ô∏è Hasil Prediksi Tingkat Kerusakan: **{label}**")
    except Exception as e:
        st.error(f"Terjadi kesalahan: {e}")

